# 7장 고급 매핑

## 상속 관계 매핑

객체의 상속 관계를 데이터베이스에 어떻게 매핑?

- 각각의 테이블로 변환 → 조인 전략
- 통합 테이블로 변환 → 단일 테이블 전략
- 서브타입 테이블로 변환 → 구현 클래스마다 테이블 전략

### 조인 전략

- 엔티티 각각을 모두 테이블로 만들고 자식 테이블이 부모 테이블의 기본 키를 받아서 기본 키 +외래 키로 사용
- @Inheritance(strategy = Inheritance.JOINED)
- 자식 테이블을 구분하려면? 구분 컬럼 필요함 : `@DiscriminatorColumn(name = “DTYPE”)`
- 자식 테이블에 엔티티 저장할 때 구분 컬럼에 입력할 값을 지정 : `@DiscriminatorValue(”M”)`

#### 장점

- 테이블 정규화
- 외래 키 참조 무결성 제약조건 활용 가능
- 저장공간 효율적으로 사용

#### 단점

- 조회 시 조인이 많이 사용됨 → 성능 저하
- 조회 쿼리 복잡
- 데이터 등록 INSERT SQL 두 번 실행
    - 부모 테이블 1번 + 자식 테이블 1번

### 단일 테이블 전략

- 테이블 하나만 사용
- @Inheritance(strategy = Inheritance.SINGLE_TABLE)
- 구분 컬럼 필수(@DiscriminatorColumn)
- 한 테이블에 모든 자식 엔티티에 관련된 컬럼 존재
- **자식 엔티티가 매핑한 컬럼은 모두 null 허용해야 함**
    - 하나의 자식 엔티티 저장 시 다른 엔티티 컬럼은 사용하지 않기 때문

#### 장점

- 조인 필요 없음 → 성능👍🏻
- 조회 쿼리 단순

#### 단점

- 자식 엔티티가 매핑한 컬럼 모두 null 허용해야 함
- 테이블이 커질 수 있음 → 상황에 따라서 조회 성능이 오히려 느려질 수 있음

### 구현 클래스마다 테이블 전략

- 자식 엔티티마다 테이블 만듦(일반적으로 추천하지 않음)
- @Inheritance(strategy = Inheritance.TABLE_PER_CLASS)
- 구분 컬럼 사용하지 않음

#### 장점

- 서브 타입 구분해서 처리할 때 효과적
- not null 제약조건 사용 가능

#### 단점

- 여러 자식 테이블을 함께 조회할 때 성능👎🏻 (SQL UNION 사용)
- 자식 테이블 통합해서 쿼리하기 어려움

## @MappedSuperclass

여러 엔티티에서 공통으로 사용하는 매핑 정보만 상속받을 때 사용

- 테이블과 매핑할 필요 없고, 자식 엔티티에게 공통으로 사용되는 매핑 정보만 제공
- 추상 클래스로 만드는 것 권장

추가) JPA Auditing - [https://www.baeldung.com/database-auditing-jpa](https://www.baeldung.com/database-auditing-jpa)

## 복합 키와 식별 관계 매핑

- 식별 vs 비식별
- 필수적 비식별 vs 선택적 비식별

⇒ 제가 다니는 회사는 비식별. 식별 선택할 경우 비즈니스 규칙이 변경되는 것에 대해 유연하지 못하는 것 같다는 생각!

### 복합 키 : 비식별 관계 매핑

- 식별자 필드가 2개 이상이면 별도의 식별자 클래스를 만들고 그곳에 equals와 hashCode 구현해야 함
- @IdClass (관게형 데이터베이스에 가까움), @EmbeddedId(객체지향에 가까움) 2가지 방법 제공

### 복합 키 : 식별 관계 매핑

- 자식 테이블은 부모 테이블의 기본 키를 포함해서 복합키를 구성해야 함

### 식별, 비식별 관계 장단점

- 식별 보다 비식별 선호
- 식별
    - 조인할 때 SQL이 복잡해지고 기본 키 인덱스가 불필요하게 커질 수 있음
    - 2개 이상의 컬럼을 합해서 복합 기본 키를 만들어야 하는 경우가 많음
    - 비즈니스 요구사항은 시간이 지남에 따라 언젠가는 변한다. 식별 관계의 자연 키 컬럼들이 전파되면 변경하기 힘듦
- **될 수 있으면 비식별 관계를 사용, 기본 키는 Long 타입의 대리 키를 사용**
- 선택적 비식별 보다 필수적 비식별 사용하는 것이 좋음. (필수적 관계는 내부 조인만 사용해도 됨)

## 조인 테이블

- 기본은 조인 컬럼을 사용하고 필요하다고 판단되면 조인 테이블을 사용합시다
- 조인 테이블은 주로 다대다 관계 → 일대다, 다대일 관계로 풀어내기 위해 사용함

## 엔티티 하나에 여러 테이블 매핑

- @SecondaryTable 사용 → 한 엔티티에 여러 테이블 매핑
- 잘 사용하지 않음 (저는 한 번도 못봤습니다.)
- 이 방법 보다는 테이블당 엔티티를 각각 만들어서 일대일 매핑하는 것을 권장함
    - 항상 두 테이블을 조회하므로 최적화하기 어려움
